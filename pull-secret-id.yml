---
platform: linux
image_resource:
  type: docker-image
  source:
    repository: tkaburagi/vault-role-id
    tag: latest
inputs:
  - name: repo
outputs:
  - name: out
run:
  path: sh
  args:
    - -c
    - |
      vault -version
      export VAULT_ADDR=${VAULT_END_POINT}

      # â€¼ï¸Cheking role idâ€¼ï¸
      echo "ğŸ‘‡Role IDğŸ‘‡"
      cat /role-id

      # â€¼ï¸Pulling vault secret idâ€¼ï¸
      VAULT_TOKEN=${VAULT_INIT_TOKEN} vault write -force -format=json auth/approle/role/aws-read/secret-id \
      secret_id_num_uses=1 \
      secret_id_ttl=10 \
      token_num_uses=1 \
      token_ttl=10 \
      token_max_ttl=10 | jq -r '.data.secret_id'> out/secret-id

      # â€¼ï¸Cheking secret idâ€¼ï¸
      echo "ğŸ‘‡Secret IDğŸ‘‡"
      cat out/secret-id

      # â€¼ï¸Put Secret ID to KVâ€¼ï¸
      vault kv put kv/secret-id-concourse id=${cat out/secret-id}